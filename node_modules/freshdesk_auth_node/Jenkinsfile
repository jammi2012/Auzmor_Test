node {
properties([[$class: 'BuildDiscarderProperty', strategy: [$class: 'LogRotator', artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '10']]]);
try {
   stage('Checkout code') {
   checkout scm
   }

   stage('Unit Tests') {
   sh '''#!/bin/bash --login
   source /home/jenkins/.nvm/nvm.sh
   nvm use 4.8.4
   yarn install
   yarn test
   '''
   }

   stage('Publish Reports') {
   publishHTML(target: [allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'coverage/lcov-report/', reportFiles: 'index.html', reportName: 'Coverage Report'])
   }

   currentBuild.result = 'SUCCESS'
   } catch(any) {
   currentBuild.result = 'FAILURE'
   step([$class: 'ClaimPublisher'])
   throw any
   } finally {
   step([$class: 'Mailer', notifyEveryUnstableBuild: true, recipients: 'freshapps-engg@freshdesk.com', sendToIndividuals: false])
   deleteDir();
   }
}
